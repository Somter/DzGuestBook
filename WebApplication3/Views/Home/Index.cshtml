<div class="container">
    <h1>Гостевая книга</h1>

    @if (User.Identity.IsAuthenticated)
    {
        <p>Привет, @User.Identity.Name!</p>
        <div class="form-container">
            <form id="messageForm">
                <textarea id="messageText" name="messageText" class="form-control" required placeholder="Введите сообщение..."></textarea>
                <button type="submit">Добавить сообщение</button>
            </form>
            <form method="post" action="/Home/Logout">
                <button type="submit">Выход</button>
            </form>
        </div>
    }
    else
    {
        <div class="link-container">
            <a href="/Auth/Login" class="styled-link">Войти в систему</a>
            <a href="/Auth/Register" class="styled-link">Регистрация</a>
        </div>
    }

    <div class="messages-container" id="messages-container">
        <p>Загрузка сообщений...</p>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            function loadMessages() {
                $.getJSON("/Home/GetMessages", function (data) { 
                    $("#messages-container").empty();
                    if (data.length === 0) {
                        $("#messages-container").append("<p>Еще нет сообщений.</p>");
                    } else {
                        data.forEach(function (msg) {
                            $("#messages-container").append(`
                                        <div class="message-container">
                                            <div class="message-user">Пользователь: ${msg.userName}</div>
                                            <div class="message-text">${msg.messageText}</div>
                                            <div class="message-date">${new Date(msg.messageDate).toLocaleString()}</div>
                                        </div>
                                    `);
                        });
                    }
                }).fail(function () {
                    $("#messages-container").html("<p class='text-danger'>Ошибка загрузки сообщений.</p>");
                });
            }

            loadMessages();

            $("#messageForm").submit(function (event) {
                event.preventDefault();
                let messageText = $("#messageText").val().trim();

                if (messageText === "") return;

                $.ajax({
                    url: "/Home/AddMessage",
                    type: "POST",
                    data: { messageText: messageText },
                    success: function (response) {
                        if (response.success) {
                            $("#messageText").val("");
                            loadMessages(); 
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function () {
                        alert("Ошибка отправки сообщения.");
                    }
                });
            });

            setInterval(loadMessages, 10000);
        });
    </script>
}
